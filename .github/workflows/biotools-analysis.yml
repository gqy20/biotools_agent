name: BioTools Analysis

on:
  workflow_dispatch:
    inputs:
      github_url:
        description: 'GitHubé¡¹ç›®URL (ä¾‹å¦‚: https://github.com/user/repo)'
        required: true
        type: string
      output_formats:
        description: 'è¾“å‡ºæ ¼å¼ (html,md,json)'
        required: false
        default: 'html,md,json'
        type: string
      analysis_name:
        description: 'åˆ†æä»»åŠ¡åç§° (å¯é€‰)'
        required: false
        default: 'biotools-analysis'
        type: string

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
  OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
  HUB_TOKEN: ${{ secrets.HUB_TOKEN }}

jobs:
  analyze-biotools:
    runs-on: ubuntu-latest
    environment: biotools
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: å®‰è£…uvåŒ…ç®¡ç†å™¨
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: éªŒè¯è¾“å…¥URL
      run: |
        if [[ ! "${{ github.event.inputs.github_url }}" =~ ^https://github\.com/.+/.+ ]]; then
          echo "âŒ é”™è¯¯: è¯·æä¾›æœ‰æ•ˆçš„GitHub URLæ ¼å¼"
          echo "   ç¤ºä¾‹: https://github.com/username/repository"
          exit 1
        fi
        echo "âœ… URLæ ¼å¼éªŒè¯é€šè¿‡: ${{ github.event.inputs.github_url }}"
    
    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        uv pip install --system -e .
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
    
    - name: éªŒè¯é…ç½®
      run: |
        biotools-agent config
    
    - name: åˆ›å»ºè¾“å‡ºç›®å½•
      run: |
        mkdir -p analysis-results
        echo "ğŸ“ åˆ›å»ºè¾“å‡ºç›®å½•: analysis-results"
    
    - name: æ‰§è¡Œç”Ÿç‰©ä¿¡æ¯å­¦å·¥å…·åˆ†æ
      run: |
        echo "ğŸš€ å¼€å§‹åˆ†æé¡¹ç›®: ${{ github.event.inputs.github_url }}"
        echo "ğŸ“Š è¾“å‡ºæ ¼å¼: ${{ github.event.inputs.output_formats }}"
        echo "ğŸ·ï¸ ä»»åŠ¡åç§°: ${{ github.event.inputs.analysis_name }}"
        
        timeout 300 biotools-agent analyze \
          "${{ github.event.inputs.github_url }}" \
          --output analysis-results \
          --formats "${{ github.event.inputs.output_formats }}" \
        || {
          echo "âŒ åˆ†æè¶…æ—¶æˆ–å¤±è´¥"
          echo "è¯·æ£€æŸ¥é¡¹ç›®URLæ˜¯å¦æœ‰æ•ˆï¼Œæˆ–è”ç³»ç®¡ç†å‘˜"
          exit 1
        }
    
    - name: ç”Ÿæˆåˆ†ææ‘˜è¦
      run: |
        echo "ğŸ“‹ ç”Ÿæˆåˆ†æç»“æœæ‘˜è¦..."
        
        # æå–é¡¹ç›®åç§°
        PROJECT_NAME=$(basename "${{ github.event.inputs.github_url }}")
        echo "é¡¹ç›®åç§°: $PROJECT_NAME"
        
        # ç»Ÿè®¡ç”Ÿæˆçš„æ–‡ä»¶
        echo "## ğŸ“Š åˆ†æç»“æœæ‘˜è¦" > analysis-results/SUMMARY.md
        echo "" >> analysis-results/SUMMARY.md
        echo "**åˆ†æé¡¹ç›®**: ${{ github.event.inputs.github_url }}" >> analysis-results/SUMMARY.md
        echo "**åˆ†ææ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> analysis-results/SUMMARY.md
        echo "**ä»»åŠ¡åç§°**: ${{ github.event.inputs.analysis_name }}" >> analysis-results/SUMMARY.md
        echo "**è¾“å‡ºæ ¼å¼**: ${{ github.event.inputs.output_formats }}" >> analysis-results/SUMMARY.md
        echo "" >> analysis-results/SUMMARY.md
        echo "### ç”Ÿæˆçš„æ–‡ä»¶" >> analysis-results/SUMMARY.md
        echo "" >> analysis-results/SUMMARY.md
        
        find analysis-results -type f \( -name "*.html" -o -name "*.md" -o -name "*.json" \) | while read file; do
          size=$(stat -c%s "$file" 2>/dev/null || echo "0")
          echo "- ğŸ“„ \`$(basename "$file")\` (${size} bytes)" >> analysis-results/SUMMARY.md
        done
        
        echo "" >> analysis-results/SUMMARY.md
        echo "### å¿«é€Ÿé¢„è§ˆ" >> analysis-results/SUMMARY.md
        echo "" >> analysis-results/SUMMARY.md
        
        # å°è¯•æå–é¡¹ç›®åŸºæœ¬ä¿¡æ¯
        if ls analysis-results/*.json 1> /dev/null 2>&1; then
          JSON_FILE=$(ls analysis-results/*.json | head -1)
          if command -v jq >/dev/null 2>&1; then
            echo "**é¡¹ç›®è¯­è¨€**: $(jq -r '.repository.language // "æœªçŸ¥"' "$JSON_FILE")" >> analysis-results/SUMMARY.md
            echo "**Stars**: $(jq -r '.repository.stars // 0' "$JSON_FILE")" >> analysis-results/SUMMARY.md
            echo "**ä¸»è¦ç”¨é€”**: $(jq -r '.functionality.main_purpose // "æœªè¯´æ˜"' "$JSON_FILE")" >> analysis-results/SUMMARY.md
          fi
        fi
        
        cat analysis-results/SUMMARY.md
    
    - name: ä¸Šä¼ åˆ†æç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: biotools-analysis-${{ github.event.inputs.analysis_name }}-${{ github.run_number }}
        path: analysis-results/
        retention-days: 30
    
    - name: è¾“å‡ºä¸‹è½½é“¾æ¥æç¤º
      run: |
        echo "ğŸ‰ åˆ†æå®Œæˆï¼"
        echo ""
        echo "ğŸ“ åˆ†æç»“æœå·²ä¿å­˜ä¸ºGitHub Artifacts"
        echo "ğŸ’¾ æ–‡ä»¶ä¿ç•™æœŸ: 30å¤©"
        echo "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ“‹ åˆ†ææ‘˜è¦:"
        cat analysis-results/SUMMARY.md | tail -n +8
    
    - name: åˆ›å»ºè¯„è®º (å¦‚æœæ˜¯PRè§¦å‘)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const artifactUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
          const comment = `
          ## ğŸ§¬ BioTools Analysis å®Œæˆ
          
          **åˆ†æé¡¹ç›®**: ${{ github.event.inputs.github_url }}
          **ä»»åŠ¡åç§°**: ${{ github.event.inputs.analysis_name }}
          
          ğŸ“ [ä¸‹è½½åˆ†æç»“æœ](${artifactUrl})
          
          ç”Ÿæˆçš„æŠ¥å‘ŠåŒ…å«:
          - ğŸ“„ HTMLå¯è§†åŒ–æŠ¥å‘Š
          - ğŸ“ Markdownæ–‡æ¡£
          - ğŸ“Š ç»“æ„åŒ–JSONæ•°æ®
          
          æŠ¥å‘Šæœ‰æ•ˆæœŸ30å¤©ã€‚
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
