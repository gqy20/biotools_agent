name: Batch BioTools Analysis

on:
  workflow_dispatch:
    inputs:
      csv_content:
        description: 'CSVæ ¼å¼çš„URLåˆ—è¡¨ (æ¯è¡Œä¸€ä¸ªURL)'
        required: true
        type: string
      analysis_name:
        description: 'æ‰¹é‡åˆ†æä»»åŠ¡åç§°'
        required: false
        default: 'batch-analysis'
        type: string

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
  OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  batch-analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: å®‰è£…uvå’Œä¾èµ–
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        uv pip install --system -e .
    
    - name: å‡†å¤‡URLåˆ—è¡¨
      run: |
        echo "ğŸ“ å‡†å¤‡åˆ†æURLåˆ—è¡¨..."
        echo "${{ github.event.inputs.csv_content }}" > urls.txt
        
        # éªŒè¯URLæ ¼å¼
        while IFS= read -r url; do
          if [[ -n "$url" && ! "$url" =~ ^https://github\.com/.+/.+ ]]; then
            echo "âŒ æ— æ•ˆURL: $url"
            exit 1
          fi
        done < urls.txt
        
        echo "âœ… URLåˆ—è¡¨éªŒè¯é€šè¿‡"
        cat urls.txt
    
    - name: æ‰¹é‡æ‰§è¡Œåˆ†æ
      run: |
        mkdir -p batch-results
        failed_urls=""
        success_count=0
        total_count=0
        
        while IFS= read -r url; do
          if [[ -z "$url" ]]; then continue; fi
          
          total_count=$((total_count + 1))
          project_name=$(basename "$url")
          echo ""
          echo "ğŸ”„ [$total_count] åˆ†æé¡¹ç›®: $project_name"
          echo "ğŸ”— URL: $url"
          
          if timeout 300 biotools-agent analyze "$url" --output "batch-results/$project_name" --formats "html,md,json"; then
            echo "âœ… [$total_count] $project_name åˆ†ææˆåŠŸ"
            success_count=$((success_count + 1))
          else
            echo "âŒ [$total_count] $project_name åˆ†æå¤±è´¥"
            failed_urls="$failed_urls\n- $url"
          fi
          
          # é¿å…APIé™åˆ¶ï¼Œé—´éš”15ç§’
          if [[ $total_count -lt $(wc -l < urls.txt) ]]; then
            echo "â¸ï¸ ç­‰å¾…15ç§’é¿å…APIé™åˆ¶..."
            sleep 15
          fi
        done < urls.txt
        
        # ç”Ÿæˆæ‰¹é‡åˆ†ææŠ¥å‘Š
        echo "# ğŸ“Š æ‰¹é‡åˆ†æç»“æœæŠ¥å‘Š" > batch-results/BATCH_SUMMARY.md
        echo "" >> batch-results/BATCH_SUMMARY.md
        echo "**åˆ†ææ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> batch-results/BATCH_SUMMARY.md
        echo "**ä»»åŠ¡åç§°**: ${{ github.event.inputs.analysis_name }}" >> batch-results/BATCH_SUMMARY.md
        echo "**æ€»é¡¹ç›®æ•°**: $total_count" >> batch-results/BATCH_SUMMARY.md
        echo "**æˆåŠŸæ•°é‡**: $success_count" >> batch-results/BATCH_SUMMARY.md
        echo "**æˆåŠŸç‡**: $(( success_count * 100 / total_count ))%" >> batch-results/BATCH_SUMMARY.md
        echo "" >> batch-results/BATCH_SUMMARY.md
        
        if [[ -n "$failed_urls" ]]; then
          echo "## âŒ å¤±è´¥çš„é¡¹ç›®" >> batch-results/BATCH_SUMMARY.md
          echo -e "$failed_urls" >> batch-results/BATCH_SUMMARY.md
          echo "" >> batch-results/BATCH_SUMMARY.md
        fi
        
        echo "## ğŸ“ æˆåŠŸç”Ÿæˆçš„æŠ¥å‘Š" >> batch-results/BATCH_SUMMARY.md
        find batch-results -name "*.html" | while read file; do
          project=$(basename $(dirname "$file"))
          echo "- ğŸ“„ [$project]($(basename "$file"))" >> batch-results/BATCH_SUMMARY.md
        done
        
        cat batch-results/BATCH_SUMMARY.md
    
    - name: ä¸Šä¼ æ‰¹é‡åˆ†æç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: batch-biotools-analysis-${{ github.event.inputs.analysis_name }}-${{ github.run_number }}
        path: batch-results/
        retention-days: 30
    
    - name: è¾“å‡ºç»“æœæ‘˜è¦
      run: |
        echo "ğŸ‰ æ‰¹é‡åˆ†æå®Œæˆï¼"
        echo "ğŸ“ ç»“æœå·²ä¸Šä¼ ä¸ºArtifactsï¼Œä¿ç•™30å¤©"
        echo "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
